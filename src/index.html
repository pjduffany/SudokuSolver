
<!--
  Attribution:
    Primary Author: Patrick Duffany
    Contributor: Zack Ahmed
-->
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Sudoku in WASM</title>
  <style>
    table {
      border-collapse: collapse;
      margin: 30px auto;
      border: 3px solid #222;
    }

    td {
      width: 2.2em;
      height: 2.2em;
      text-align: center;
      vertical-align: middle;
      font-size: 1.4em;
      font-family: monospace;
      border: 1px solid #aaa;
      background-color: #fff;
    }

    /* Highlight outer border of 3x3 boxes */
    td:nth-child(3), td:nth-child(6) {
      border-right: 3px solid #222;
    }

    tr:nth-child(3) td, tr:nth-child(6) td {
      border-bottom: 3px solid #222;
    }

    .given {
      background: #eef;
      font-weight: bold;
      color: #333;
    }

    .solved {
      background: #d9f9d9;
      color: #222;
    }
  </style>
</head>
<body>
<h1 style="text-align:center">Sudoku Solver</h1>
<div style="text-align: center; margin-top: 1em;">
  <label for="difficulty">Difficulty:</label>
  <select id="difficulty">
    <option value="30">Easy</option>
    <option value="45">Medium</option>
    <option value="55">Hard</option>
  </select>
  <button id="new">New Puzzle</button>
  <button id="solve">Solve Puzzle</button>
</div>
<table id="grid"></table>
<script src="sudoku.js"></script>
<script>
  SudokuModule().then(mod => {
    const N = 9;
    const grid = document.getElementById("grid");
    // Allocate 81 ints (4 bytes each) in WASM memory
    let ptr = mod._malloc(81 * 4);
    let heap = new Int32Array(mod.HEAP32.buffer, ptr, 81);  // allocate once

    // build the HTML table
    for (let r = 0; r < N; r++) {
      const row = grid.insertRow();
      for (let c = 0; c < N; c++) {
        const cell = row.insertCell();
        cell.contentEditable = false;  // toggle this for user input
      }
    }

    /**
     * Description: Render the 9x9 puzzle grid.
     * Author: Patrick Duffany, Zack Ahmed
     * Param: {Int32Array} heap        flat 81-element array of cell values
     * Param: {"given"|"solved"} mode  whether to mark cells as given or solved 
     * Side-effects: manipulates cell.innerText and cell.classList
     * Vulnerability: Catching Exceptions [3-1] catches error if WASM-loading fails
     * Vulnerability: Information Leakage [5-1] using innerText vs innerHTML prevents injection of HTML/JS
     */

    function renderGrid(heap, mode) {

      for (let idx = 0; idx < N * N; idx++) {
        const r = Math.floor(idx / N);
        const c = idx % N;
        const val = heap[idx];
        const cell = grid.rows[r].cells[c];
        // update the text content
        cell.innerText = val || "";

        if (mode === "given"){
          cell.classList.remove("given", "solved");
          if(val){
            cell.classList.add("given");
          }
        }else if(mode === "solved"){
          cell.classList.remove("solved");
          if(!cell.classList.contains("given")){
            cell.classList.add("solved");
          }
        }
      }
    }
    // hook up the “New Puzzle” button
    document.getElementById("new").onclick = () => {
      const difficulty = parseInt(document.getElementById("difficulty").value, 10);

      if (ptr !== null) mod._free(ptr);
      ptr = mod._malloc(81 * 4); // reallocate
      heap = new Int32Array(mod.HEAP32.buffer, ptr, 81); //  refresh view
      mod._generate_puzzle(ptr, difficulty);
      renderGrid(heap, "given");
      document.getElementById("solve").disabled = false; // reenable the solve button

    };

    // hook up the "Solve Puzzle" button
    document.getElementById("solve").onclick = () => {
      mod._fill_puzzle(ptr); // call into C to solve it (same flat buffer)
      renderGrid(heap, "solved");
      document.getElementById("solve").disabled = true; // disable to prevent multiple solves

    };

    // generate one on load
    document.getElementById("new").click();
  })
  .catch(err => {
      console.error("WASM load error:", err);
      // Inform the user
      alert("Failed to load the Sudoku WebAssembly module:\n" + err);
      // Disable controls to prevent further errors
      document.getElementById("new").disabled = true;
      document.getElementById("solve").disabled = true;
  });
</script>
</body>
</html>